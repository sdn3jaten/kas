<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Kas Kelas</title>
    <style>
        /* --- SEMUA STYLE TETAP SAMA --- */
        :root {
            --primary-color: #0D28A6;
            --primary-light: #E9EFFC;
            --secondary-color: #F3F4F8;
            --success-color: #3ECF4E;
            --danger-color: #E31E1E;
            --text-primary: #1A1A1A;
            --text-secondary: #8A8A8A;
            --border-color: #E0E0E0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-primary); position: relative; height: 100vh; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .admin-banner { background-color: var(--danger-color); color: white; text-align: center; padding: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .app-header { background-color: var(--primary-color); color: white; padding: 1.5rem 1rem; text-align: center; box-shadow: var(--shadow-md); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 1.2rem; font-weight: 500; }
        .settings-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s; }
        .settings-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 80px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .balance-card { background: linear-gradient(135deg, var(--primary-color), #4B6CDF); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: var(--shadow-md); margin-bottom: 1.5rem; }
        .balance-card .label { font-size: 0.9rem; opacity: 0.8; }
        .balance-card .amount { font-size: 2.5rem; font-weight: bold; margin-top: 0.5rem; }
        .summary-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .summary-card { background: white; padding: 1rem; border-radius: 10px; box-shadow: var(--shadow-sm); text-align: center; }
        .summary-card .label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .summary-card .amount { font-size: 1.2rem; font-weight: bold; }
        .summary-card.income .amount { color: var(--success-color); }
        .summary-card.expense .amount { color: var(--danger-color); }
        .home-section { background: white; border-radius: 10px; padding: 1rem; box-shadow: var(--shadow-sm); }
        .home-section .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .home-section .section-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .home-section .see-all-link { font-size: 0.9rem; color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .dues-list-container { display: flex; flex-direction: column; gap: 0.75rem; }
        .dues-list-item { background: white; border-radius: 10px; box-shadow: var(--shadow-sm); overflow: hidden; transition: box-shadow 0.2s; }
        .dues-list-item.expanded { box-shadow: var(--shadow-md); }
        .dues-list-item-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; }
        .dues-list-item-header .info { flex-grow: 1; }
        .dues-list-item-header .name { font-weight: 600; font-size: 1rem; }
        .dues-list-item-header .status { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.2rem; }
        .dues-list-item-header .amounts { text-align: right; }
        .dues-list-item-header .total { font-weight: bold; font-size: 1rem; color: var(--success-color); }
        .dues-list-item-header .kurang { font-size: 0.8rem; color: var(--danger-color); }
        .dues-list-item-header .chevron { margin-left: 1rem; color: var(--text-secondary); transition: transform 0.3s ease; }
        .dues-list-item.expanded .chevron { transform: rotate(180deg); }
        .dues-list-item-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; background-color: var(--secondary-color); padding: 0 1rem; }
        .dues-list-item.expanded .dues-list-item-details { max-height: 500px; padding: 1rem; }
        .monthly-payments-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; font-size: 0.85rem; }
        .payment-month { background: white; padding: 0.5rem; border-radius: 6px; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .payment-month.paid { background-color: var(--primary-light); color: var(--primary-color); font-weight: 500; }
        .payment-month.unpaid { color: var(--text-secondary); }
        .payment-month.unpaid:hover { background-color: #e0e0e0; }
        .history-list { list-style-type: none; }
        .history-item { background: white; display: flex; align-items: center; padding: 1rem; border-radius: 10px; box-shadow: var(--shadow-sm); margin-bottom: 0.75rem; transition: transform 0.2s, box-shadow 0.2s; }
        .history-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .history-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; }
        .history-icon.income { background-color: var(--success-color); color: white; }
        .history-icon.expense { background-color: var(--danger-color); color: white; }
        .history-details { flex-grow: 1; }
        .history-details .desc { font-weight: 500; font-size: 0.95rem; }
        .history-details .date { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.2rem; }
        .history-amount { font-weight: bold; font-size: 1rem; }
        .history-amount.income { color: var(--success-color); }
        .history-amount.expense { color: var(--danger-color); }
        .tab-container { display: flex; background-color: white; border-radius: 10px; padding: 0.25rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); }
        .tab-button { flex: 1; padding: 0.75rem; border: none; background: none; color: var(--text-secondary); font-size: 0.95rem; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: var(--primary-color); color: white; }
        .tab-content { position: relative; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .add-expense-form { background: white; padding: 1rem; border-radius: 10px; box-shadow: var(--shadow-sm); margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #0a1f7a; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #36b846; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c91a1a; }
        .btn-block { width: 100%; display: block; }
        .save-button-container { position: fixed; bottom: 80px; left: 1rem; right: 1rem; z-index: 15; }
        .message { text-align: center; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; font-weight: 500; }
        .message.success { background-color: var(--success-color); color: white; }
        .message.error { background-color: var(--danger-color); color: white; }
        .message.info { background-color: var(--primary-color); color: white; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; display: flex; justify-content: space-around; padding: 0.5rem 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 20; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 0.5rem 1rem; background: none; border: none; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.75rem; }
        .settings-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .settings-modal { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: var(--shadow-md); }
        .settings-modal h2 { margin-bottom: 1.5rem; text-align: center; color: var(--text-primary); }
        .settings-modal .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .settings-modal .btn-container { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .settings-modal .btn-container .btn { flex: 1; min-width: 100px; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="admin-banner">⚠️ HALAMAN ADMIN - JANGAN BAGIKAN LINK INI ⚠️</div>
        <header class="app-header">
            <h1>Admin - Kas Kelas</h1>
            <button class="settings-btn" onclick="openSettingsModal()">⚙️</button>
        </header>
        <main class="main-content">
            <div id="home-screen" class="screen active">
                <div class="balance-card"><div class="label">Saldo Kas Tersedia</div><div class="amount" id="final-balance">Rp0</div></div>
                <div class="summary-cards">
                    <div class="summary-card income"><div class="label">Total Pemasukan</div><div class="amount" id="total-income">Rp0</div></div>
                    <div class="summary-card expense"><div class="label">Total Pengeluaran</div><div class="amount" id="total-expense">Rp0</div></div>
                </div>
                <div class="home-section">
                    <div class="section-header"><h2 class="section-title">Riwayat Terakhir</h2><a href="#" id="see-all-link" class="see-all-link">Lihat Semua</a></div>
                    <ul id="recent-history-list" class="history-list"></ul>
                </div>
            </div>
            <div id="iuran-screen" class="screen"><h2 class="section-title">Data Iuran Anggota</h2><div id="dues-list-container" class="dues-list-container"></div></div>
            <div id="riwayat-screen" class="screen">
                <h2 class="section-title">Riwayat Transaksi</h2>
                <div class="tab-container">
                    <button class="tab-button active" data-tab="income">Kas Masuk</button>
                    <button class="tab-button" data-tab="expense">Pengeluaran</button>
                </div>
                <div class="tab-content">
                    <ul id="income-list" class="history-list tab-pane active"></ul>
                    <div id="expense-pane" class="tab-pane">
                        <div class="add-expense-form">
                            <h3 style="margin-bottom: 1rem;">Tambah Pengeluaran Baru</h3>
                            <div class="form-group"><label for="expense-date">Tanggal</label><input type="date" id="expense-date" required></div>
                            <div class="form-group"><label for="expense-desc">Keterangan</label><input type="text" id="expense-desc" placeholder="Contoh: Beli spidol" required></div>
                            <div class="form-group"><label for="expense-amount">Jumlah</label><input type="number" id="expense-amount" placeholder="Contoh: 25000" required></div>
                            <button class="btn btn-primary btn-block" onclick="addNewExpense()">Tambah Pengeluaran</button>
                        </div>
                        <ul id="expense-list" class="history-list"></ul>
                    </div>
                </div>
            </div>
        </main>
        <div class="save-button-container" id="save-button-container" style="display: none;">
            <div id="message-area"></div>
            <button class="btn btn-success btn-block" onclick="saveAllChanges()">Simpan Semua Perubahan</button>
        </div>
        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="home-screen"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Beranda</span></button>
            <button class="nav-item" data-screen="iuran-screen"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg><span>Iuran</span></button>
            <button class="nav-item" data-screen="riwayat-screen"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg><span>Riwayat</span></button>
        </nav>
    </div>
    <div id="settings-overlay" class="settings-overlay" style="display: none;">
        <div class="settings-modal">
            <h2>Pengaturan API GitHub</h2>
            <form id="settings-form">
                <div class="form-group"><label for="setting-owner">Username (Owner)</label><input type="text" id="setting-owner" required></div>
                <div class="form-group"><label for="setting-repo">Nama Repository</label><input type="text" id="setting-repo" required></div>
                <div class="form-group"><label for="setting-token">Personal Access Token</label><input type="password" id="setting-token" required></div>
                <div class="form-group"><label for="setting-branch">Cabang (Branch)</label><input type="text" id="setting-branch" value="main"></div>
                <div class="btn-container">
                    <button type="button" class="btn btn-primary" onclick="testConnection()">Tes Koneksi</button>
                    <button type="submit" class="btn btn-success">Simpan</button>
                    <button type="button" class="btn btn-danger" onclick="clearSettings()">Hapus</button>
                </div>
            </form>
        </div>
    </div>
    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let membersData = [], expensesData = [], hasUnsavedChanges = false;
            function parseRupiah(str) { if (!str || str === "") return 0; return parseInt(str.replace(/[^\d]/g, ''), 10); }
            function formatRupiah(num) { return "Rp" + num.toLocaleString('id-ID'); }
            function formatDate(dateString) { const date = new Date(dateString); const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; return date.toLocaleDateString('id-ID', options); }
            function showMessage(text, type = 'info') { const messageArea = document.getElementById('message-area'); messageArea.innerHTML = `<div class="message ${type}">${text}</div>`; setTimeout(() => { messageArea.innerHTML = ''; }, 5000); }
            function toggleSaveButton(show) { document.getElementById('save-button-container').style.display = show ? 'block' : 'none'; }
            
            // --- SETTINGS MODAL LOGIC ---
            function openSettingsModal() {
                document.getElementById('setting-owner').value = localStorage.getItem('github_owner') || '';
                document.getElementById('setting-repo').value = localStorage.getItem('github_repo') || '';
                document.getElementById('setting-token').value = localStorage.getItem('github_token') || '';
                document.getElementById('setting-branch').value = localStorage.getItem('github_branch') || 'main';
                document.getElementById('settings-overlay').style.display = 'flex';
            }
            function closeSettingsModal() { document.getElementById('settings-overlay').style.display = 'none'; }
            
            // --- NEW: TEST CONNECTION FUNCTION ---
            async function testConnection() {
                const testConfig = {
                    owner: document.getElementById('setting-owner').value,
                    repo: document.getElementById('setting-repo').value,
                    token: document.getElementById('setting-token').value,
                    branch: document.getElementById('setting-branch').value || 'main'
                };
                if (!testConfig.owner || !testConfig.repo || !testConfig.token) { showMessage('Mohon isi Username, Repository, dan Token sebelum melakukan tes.', 'error'); return; }
                const testBtn = document.querySelector('.btn-primary'); const originalText = testBtn.textContent;
                testBtn.textContent = 'Menguji...'; testBtn.disabled = true;
                try {
                    await GitHubAPI.getFile('kas.json', testConfig);
                    showMessage('Koneksi berhasil! Pengaturan valid.', 'success');
                } catch (error) {
                    console.error('Connection test failed:', error);
                    showMessage(`Koneksi gagal: ${error.message}. Periksa kembali token, nama repository, dan cabang Anda.`, 'error');
                } finally {
                    testBtn.textContent = originalText; testBtn.disabled = false;
                }
            }

            // --- REVISED: SAVE SETTINGS FUNCTION ---
            async function saveSettings(e) {
                e.preventDefault();
                localStorage.setItem('github_owner', document.getElementById('setting-owner').value);
                localStorage.setItem('github_repo', document.getElementById('setting-repo').value);
                localStorage.setItem('github_token', document.getElementById('setting-token').value);
                localStorage.setItem('github_branch', document.getElementById('setting-branch').value);
                
                showMessage('Pengaturan berhasil disimpan! Memuat ulang data...', 'success');
                closeSettingsModal();
                
                try {
                    await loadData();
                    showMessage('Data berhasil dimuat! Anda sekarang dapat mengedit data.', 'success');
                } catch (error) {
                    console.error('Error loading data after saving settings:', error);
                    showMessage('Gagal memuat data dengan pengaturan baru. Periksa kembali pengaturan Anda.', 'error');
                }
            }

            function clearSettings() { if (confirm('Apakah Anda yakin ingin menghapus semua pengaturan?')) { localStorage.removeItem('github_owner'); localStorage.removeItem('github_repo'); localStorage.removeItem('github_token'); localStorage.removeItem('github_branch'); showMessage('Pengaturan dihapus. Halaman akan dimuat ulang.', 'info'); setTimeout(() => { window.location.reload(); }, 1500); } }

            // --- DATA FETCHING AND INITIALIZATION ---
            async function loadData() {
                try {
                    const [kas, pengeluaran] = await Promise.all([GitHubAPI.getFile('kas.json'), GitHubAPI.getFile('pengeluaran.json')]);
                    membersData = kas; expensesData = pengeluaran; initializeApp();
                } catch (error) {
                    console.error('Error loading data:', error);
                    if (error.message.includes('Konfigurasi API')) { showMessage('Silakan lengkapi pengaturan API terlebih dahulu.', 'error'); openSettingsModal(); } else { document.querySelector('.main-content').innerHTML = `<div class="message error">Gagal memuat data. Periksa pengaturan Anda. Error: ${error.message}</div>`; }
                }
            }
            function initializeApp() { renderSummary(); renderDuesList(); initializeHistoryScreen(); renderRecentHistory(); setupEventListeners(); }
            
            // --- RENDER FUNCTIONS (Tetap Sama) ---
            function renderSummary() { const totalIncome = membersData.reduce((sum, member) => sum + parseRupiah(member.total), 0); const totalExpense = expensesData.reduce((sum, expense) => sum + parseRupiah(expense.jumlah), 0); const finalBalance = totalIncome - totalExpense; document.getElementById('total-income').innerText = formatRupiah(totalIncome); document.getElementById('total-expense').innerText = formatRupiah(totalExpense); document.getElementById('final-balance').innerText = formatRupiah(finalBalance); }
            function renderDuesList() { const listContainer = document.getElementById('dues-list-container'); listContainer.innerHTML = ''; const months = ['juli', 'agustus', 'september', 'oktober', 'november', 'desember', 'januari', 'februari', 'maret', 'april', 'mei', 'juni']; const monthNames = ['Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun']; membersData.forEach((member, memberIndex) => { const listItem = document.createElement('div'); listItem.className = 'dues-list-item'; const header = document.createElement('div'); header.className = 'dues-list-item-header'; header.innerHTML = `<div class="info"><div class="name">${member.nama}</div><div class="status">Status: ${member.kurang === 'Rp0' ? 'Lunas' : 'Belum Lunas'}</div></div><div class="amounts"><div class="total">${member.total}</div><div class="kurang">Kurang: ${member.kurang}</div></div><div class="chevron">▼</div>`; listItem.appendChild(header); const details = document.createElement('div'); details.className = 'dues-list-item-details'; let monthlyGridHTML = ''; months.forEach((monthKey, index) => { const monthData = member[monthKey]; const isPaid = monthData && monthData.amount !== ""; monthlyGridHTML += `<div class="payment-month ${isPaid ? 'paid' : 'unpaid'}" data-member-index="${memberIndex}" data-month="${monthKey}">${monthNames[index]}</div>`; }); details.innerHTML = `<div class="monthly-payments-grid">${monthlyGridHTML}</div>`; listItem.appendChild(details); header.addEventListener('click', () => listItem.classList.toggle('expanded')); listContainer.appendChild(listItem); }); }
            function initializeHistoryScreen() { const incomeTransactions = []; membersData.forEach(member => { const months = ['juli', 'agustus', 'september', 'oktober', 'november', 'desember', 'januari', 'februari', 'maret', 'april', 'mei', 'juni']; months.forEach(month => { const monthData = member[month]; if (monthData && monthData.amount !== "") { incomeTransactions.push({ date: monthData.date, formattedDate: formatDate(monthData.date), description: member.nama, amount: monthData.amount }); } }); }); incomeTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)); renderTransactionList('income-list', incomeTransactions, 'income'); const sortedExpenses = [...expensesData].sort((a, b) => new Date(b.tanggal.split(', ')[1].trim()) - new Date(a.tanggal.split(', ')[1].trim())); renderTransactionList('expense-list', sortedExpenses, 'expense'); }
            function renderTransactionList(listId, transactions, type) { const listContainer = document.getElementById(listId); listContainer.innerHTML = ''; if (transactions.length === 0) { listContainer.innerHTML = `<li class="history-item"><div class="history-details"><div class="desc">Belum ada transaksi.</div></div></li>`; return; } transactions.forEach(transaction => { const listItem = document.createElement('li'); listItem.className = 'history-item'; listItem.innerHTML = `<div class="history-icon ${type}">${type === 'income' ? '+' : '-'}</div><div class="history-details"><div class="desc">${transaction.description}</div><div class="date">${transaction.formattedDate || transaction.tanggal}</div></div><div class="history-amount ${type}">${type === 'income' ? '+' : '-'} ${transaction.amount}</div>`; listContainer.appendChild(listItem); }); }
            function renderRecentHistory() { const listContainer = document.getElementById('recent-history-list'); listContainer.innerHTML = ''; const allTransactions = []; membersData.forEach(member => { const months = ['juli', 'agustus', 'september', 'oktober', 'november', 'desember', 'januari', 'februari', 'maret', 'april', 'mei', 'juni']; months.forEach(month => { const monthData = member[month]; if (monthData && monthData.amount !== "") { allTransactions.push({ type: 'income', date: monthData.date, formattedDate: formatDate(monthData.date), description: member.nama, amount: monthData.amount }); } }); }); expensesData.forEach(expense => { allTransactions.push({ type: 'expense', date: expense.tanggal, formattedDate: expense.tanggal, description: expense.jenis, amount: expense.jumlah }); }); allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)); const recentTransactions = allTransactions.slice(0, 5); recentTransactions.forEach(transaction => { const listItem = document.createElement('li'); listItem.className = 'history-item'; listItem.innerHTML = `<div class="history-icon ${transaction.type}">${transaction.type === 'income' ? '+' : '-'}</div><div class="history-details"><div class="desc">${transaction.description}</div><div class="date">${transaction.formattedDate}</div></div><div class="history-amount ${transaction.type}">${transaction.type === 'income' ? '+' : '-'} ${transaction.amount}</div>`; listContainer.appendChild(listItem); }); }
            
            // --- EVENT LISTENERS & ACTIONS ---
            function setupEventListeners() {
                document.getElementById('settings-form').addEventListener('submit', saveSettings);
                document.getElementById('settings-overlay').addEventListener('click', (e) => { if (e.target.id === 'settings-overlay') { closeSettingsModal(); } });
                const navItems = document.querySelectorAll('.nav-item'); const screens = document.querySelectorAll('.screen');
                navItems.forEach(item => { item.addEventListener('click', () => { const targetScreenId = item.dataset.screen; navItems.forEach(nav => nav.classList.remove('active')); screens.forEach(screen => screen.classList.remove('active')); item.classList.add('active'); document.getElementById(targetScreenId).classList.add('active'); }); });
                document.getElementById('see-all-link').addEventListener('click', (e) => { e.preventDefault(); document.querySelector('[data-screen="riwayat-screen"]').click(); });
                const tabButtons = document.querySelectorAll('.tab-button'); const tabPanes = document.querySelectorAll('.tab-pane');
                tabButtons.forEach(button => { button.addEventListener('click', () => { const targetTab = button.getAttribute('data-tab'); tabButtons.forEach(btn => btn.classList.remove('active')); tabPanes.forEach(pane => pane.classList.remove('active')); button.classList.add('active'); document.getElementById(`${targetTab}-list`).classList.add('active'); document.getElementById(`${targetTab}-pane`).classList.add('active'); }); });
                document.getElementById('dues-list-container').addEventListener('click', (e) => { if (e.target.classList.contains('payment-month')) { const memberIndex = e.target.dataset.memberIndex; const monthKey = e.target.dataset.month; const member = membersData[memberIndex]; if (member[monthKey] && member[monthKey].amount !== "") { member[monthKey] = ""; } else { member[monthKey] = { amount: "Rp15.000", date: new Date().toISOString().split('T')[0] }; } let total = 0; const months = ['juli', 'agustus', 'september', 'oktober', 'november', 'desember', 'januari', 'februari', 'maret', 'april', 'mei', 'juni']; months.forEach(m => { if (member[m] && member[m].amount !== "") total += parseRupiah(member[m].amount); }); member.total = formatRupiah(total); member.kurang = formatRupiah((12 * 15000) - total); hasUnsavedChanges = true; toggleSaveButton(true); renderDuesList(); renderSummary(); } });
            }
            function addNewExpense() { const date = document.getElementById('expense-date').value; const desc = document.getElementById('expense-desc').value; const amount = document.getElementById('expense-amount').value; if (!date || !desc || !amount) { showMessage('Semua field harus diisi!', 'error'); return; } const newExpense = { tanggal: formatDate(new Date(date)), jenis: desc, jumlah: formatRupiah(parseInt(amount)) }; expensesData.unshift(newExpense); hasUnsavedChanges = true; toggleSaveButton(true); document.getElementById('expense-date').value = ''; document.getElementById('expense-desc').value = ''; document.getElementById('expense-amount').value = ''; initializeHistoryScreen(); renderSummary(); renderRecentHistory(); showMessage('Pengeluaran berhasil ditambahkan. Klik "Simpan Semua Perubahan" untuk menyimpan.', 'info'); }
            async function saveAllChanges() { if (!hasUnsavedChanges) return; const saveButton = document.querySelector('.save-button-container button'); saveButton.textContent = 'Menyimpan...'; saveButton.disabled = true; try { await Promise.all([GitHubAPI.putFile('kas.json', membersData, 'Update data iuran'), GitHubAPI.putFile('pengeluaran.json', expensesData, 'Update data pengeluaran')]); hasUnsavedChanges = false; toggleSaveButton(false); showMessage('Semua perubahan berhasil disimpan!', 'success'); } catch (error) { console.error('Save failed:', error); showMessage(`Gagal menyimpan: ${error.message}`, 'error'); } finally { saveButton.textContent = 'Simpan Semua Perubahan'; saveButton.disabled = false; } }
            loadData();
        });
    </script>
</body>
</html>
